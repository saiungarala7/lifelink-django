{% extends "base.html" %}
{% load static %}

{% block content %}

<style>
/* ---------- Page Animations ---------- */
.fade-in {
    animation: fadeIn 0.8s ease-in;
}
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
}

/* ---------- Profile Image ---------- */
.profile-img {
    width: 130px;
    height: 130px;
    border-radius: 50%;
    object-fit: cover;
    border: 4px solid #dc3545;
}

/* ---------- Section Card ---------- */
.profile-card {
    border: none;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.08);
}

/* ---------- Labels ---------- */
.profile-label {
    font-weight: 600;
    color: #444;
}
</style>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>


<div class="container my-5 fade-in">

    <!-- ================= HEADER ================= -->
    <div class="card profile-card mb-4 text-center p-4">
        {% if blood_bank.profile_image %}
            <img src="{{ blood_bank.profile_image.url }}"
                 class="profile-img mx-auto mb-3">
        {% else %}
            <img src="https://via.placeholder.com/130"
                 class="profile-img mx-auto mb-3">
        {% endif %}

        <h3 class="fw-bold text-danger">{{ blood_bank.name }}</h3>
        <p class="text-muted mb-0">
            {{ request.user.location_name|default:"Location not set" }}
        </p>
    </div>

    <!-- ================= PROFILE FORM ================= -->
    <form method="post" enctype="multipart/form-data">
        {% csrf_token %}

        <!-- ===== BASIC DETAILS ===== -->
        <div class="card profile-card mb-4 p-4">
            <h5 class="mb-3 text-primary">Basic Information</h5>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="profile-label">Blood Bank Name *</label>
                    <input type="text" name="name"
                           class="form-control"
                           value="{{ blood_bank.name }}"
                           readonly>
                </div>

                <div class="col-md-6">
                    <label class="profile-label">Contact Number *</label>
                    <input type="text" name="contact_number"
                           class="form-control"
                           value="{{ blood_bank.contact_number }}"
                           readonly>
                </div>

                <div class="col-md-6">
                    <label class="profile-label">Official Email</label>
                    <input type="email"
                           class="form-control"
                           value="{{ request.user.email }}"
                           readonly>
                </div>

                <div class="col-md-6">
                    <label class="profile-label">License Number</label>
                    <input type="text" name="license_number"
                           class="form-control"
                           value="{{ blood_bank.license_number }}"
                           readonly>
                </div>
            </div>
        </div>

        <!-- ===== ADDRESS & LOCATION ===== -->
        <div class="card profile-card mb-4 p-4">
            <h5 class="mb-3 text-primary">Address & Location</h5>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="profile-label">Address *</label>
                    <textarea name="address"
                              class="form-control"
                              rows="3"
                              readonly>{{ blood_bank.address }}</textarea>

                    <label class="profile-label mt-3">Location Name *</label>
                    <input type="text"
                           class="form-control"
                           value="{{ request.user.location_name }}"
                           readonly>
                </div>

               <div id="map" style="height: 230px;" class="rounded"></div>

<input type="hidden" name="latitude" id="latitude"
       value="{{ request.user.latitude }}">
<input type="hidden" name="longitude" id="longitude"
       value="{{ request.user.longitude }}">

            </div>
        </div>

        <!-- ===== ADDITIONAL DETAILS ===== -->
        <div class="card profile-card mb-4 p-4">
            <h5 class="mb-3 text-primary">Additional Details</h5>

            <div class="row g-3">
                <div class="col-md-6">
                    <label class="profile-label">Operating Hours</label>
                    <input type="text" name="operating_hours"
                           class="form-control"
                           value="{{ blood_bank.operating_hours }}"
                           readonly>
                </div>

                <div class="col-md-6">
                    <label class="profile-label">Emergency Contact</label>
                    <input type="text" name="emergency_contact"
                           class="form-control"
                           value="{{ blood_bank.emergency_contact }}"
                           readonly>
                </div>

                <div class="col-12">
                    <label class="profile-label">About Blood Bank</label>
                    <textarea name="description"
                              class="form-control"
                              rows="3"
                              readonly>{{ blood_bank.description }}</textarea>
                </div>
            </div>
        </div>

        <!-- ===== PROFILE IMAGE UPDATE ===== -->
        <div class="card profile-card mb-4 p-4">
            <h5 class="mb-3 text-primary">Profile Picture</h5>
            <input type="file"
                   name="profile_image"
                   class="form-control"
                   disabled>
        </div>

        <!-- ===== ACTION BUTTON ===== -->
        <div class="text-center">
            <button type="button"
                    class="btn btn-outline-primary px-5"
                    id="editBtn">
                ‚úèÔ∏è Edit Profile
            </button>

            <button type="submit"
                    class="btn btn-danger px-5 d-none"
                    id="saveBtn">
                üíæ Update Profile
            </button>
        </div>

    </form>

</div>
<script>
const editBtn = document.getElementById("editBtn");
const saveBtn = document.getElementById("saveBtn");

// All form inputs except email
const inputs = document.querySelectorAll(
    "input:not([type='email']), textarea"
);

editBtn.addEventListener("click", () => {
    inputs.forEach(input => {
        input.removeAttribute("readonly");
        input.removeAttribute("disabled");
    });

    editBtn.classList.add("d-none");
    saveBtn.classList.remove("d-none");
});
</script>
<script>
let lat = "{{ request.user.latitude|default_if_none:'' }}";
let lng = "{{ request.user.longitude|default_if_none:'' }}";

// Fallback to default location (Hyderabad) if empty
lat = lat ? parseFloat(lat) : 17.3850;
lng = lng ? parseFloat(lng) : 78.4867;

const map = L.map('map').setView([lat, lng], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: '¬© OpenStreetMap'
}).addTo(map);

let marker = L.marker([lat, lng], { draggable: true }).addTo(map);

// Update hidden fields
function updateLocation(position) {
    document.getElementById("latitude").value = position.lat;
    document.getElementById("longitude").value = position.lng;
}

// Marker drag
marker.on('dragend', function (e) {
    updateLocation(e.target.getLatLng());
});

// Map click
map.on('click', function (e) {
    marker.setLatLng(e.latlng);
    updateLocation(e.latlng);
});
</script>




{% endblock %}
